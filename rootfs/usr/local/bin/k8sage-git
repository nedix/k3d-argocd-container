#!/usr/bin/env bash

set -e

source /etc/profile

GIT_EMAIL="$(whoami)@k8sage.internal"
GIT_USER=k8sage

start() {
    yellow; echo "Starting GIT daemon..."; normal
    _create_symlinks
    _create_repositories
    refresh_submodules
    run_in_background /usr/bin/git daemon \
        --export-all \
        --access-hook="bash k8sage-git refresh_submodules" \
        --base-path="/opt/git/repositories" \
        /opt/git/repositories/k8sage/.git \
        /opt/git/repositories/applications/.git \
        /opt/git/repositories/applications/*/.git
    green; echo "GIT daemon started."; normal
}

stop() {
    yellow; echo "Stopping GIT daemon..."; normal
    kill -TERM $(pgrep git-daemon)
    while pgrep git-daemon > /dev/null; do
        sleep 1
    done
    green; echo "GIT daemon stopped."; normal
}

_create_symlinks() {
    yellow; echo "Creating symlinks..."; normal
    mkdir -p /opt/git/repositories/
    ln -sf {/opt/k8sage/,/mnt/applications/} /opt/git/repositories/
    green; echo "Symlinks created."; normal
}

_create_repositories() {
    yellow; echo "Creating repositories..."; normal

    yellow; echo "Creating repository for '/opt/git/repositories/k8sage/'."; normal
    cd /opt/git/repositories/k8sage/
    git init -b main
    git add -A
    git -c user.name="$GIT_USER" -c user.email="$GIT_EMAIL" commit -m "Initial commit"

    yellow; echo "Creating repository for '/opt/git/repositories/applications/'."; normal
    cd /opt/git/repositories/applications/
    git init -b main
    git -c user.name="$GIT_USER" -c user.email="$GIT_EMAIL" commit --allow-empty -m "Initial commit"

    for REPO in /opt/git/repositories/applications/*/; do
        if [ -d "${REPO}/.git" ]; then
            continue
        fi

        green; echo "Creating repository for '$REPO'."; normal
        cd "$REPO"
        git init -b main
        git add -A
        git -c user.name="$GIT_USER" -c user.email="$GIT_EMAIL" commit -m "Initial commit"
    done
    green; echo "Repositories created."; normal
}

refresh_submodules() {
    yellow; echo "Refreshing submodules..."; normal
    cd /opt/git/repositories/applications/

    for REPO in /opt/git/repositories/applications/*/; do
        local SUBMODULE="$(basename $REPO)"

        if ! git submodule status --quiet "$SUBMODULE" 2> /dev/null; then
            green; echo "Creating submodule '$SUBMODULE'."; normal
            touch .gitmodules
            git submodule add --force "git://host.k3d.internal/applications/$SUBMODULE" "$SUBMODULE"
        fi
    done

    for SUBMODULE in $(git submodule --quiet foreach "echo $path" || echo ""); do
        if [ ! -d "$SUBMODULE/.git" ]; then
            green; echo "Removing submodule '$SUBMODULE' from '$REPO'."; normal
            git config --remove-section "submodule.$SUBMODULE"
        fi
    done

    if [ -n "$(git status --porcelain -uno)" ]; then
        git -c user.name="$GIT_USER" -c user.email="$GIT_EMAIL" commit -m "Saving submodules."
    fi
    green; echo "Submodules refreshed."; normal
}

if [ "${BASH_SOURCE[0]}" = "$0" ]; then "$1" "${@:2}"; fi
